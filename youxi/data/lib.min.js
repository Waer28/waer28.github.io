function getHolder(belong){switch(belong.getAttribute("name")){case"bag":return BAG_DATA;case"box":return BOX_DATA;case"workbench":return"cook"==$("#workbench").attr("mode")?COOK_DATA:TEMP_DATA;case"stuff":return COOK_DATA;case"cookResult":return COOK_RESULT;case"toiletData":return TOILET_DATA;case"goods":return TRADE_DATA;case"tradeGet":return TRADE_GET;case"tradeGive":return TRADE_GIVE;default:return TEMP_DATA}}function getBackBtn(layer){var newBtn=newElement("button","","","btn btn-default backBtn","返回");newBtn.onclick=function(){var i;if($(".item").popover("destroy"),TRASH_FLAG){if(getSum(TEMP_DATA)>0&&void 0!=MAP_DATA[EX_TAB[EX_TAB.length-1]]&&void 0!=MAP_DATA[EX_TAB[EX_TAB.length-1]].trash)for(i in TEMP_DATA)void 0!=MAP_DATA[EX_TAB[EX_TAB.length-1]].trash[i]&&caculate(MAP_DATA[EX_TAB[EX_TAB.length-1]].trash[i],"amount",TEMP_DATA[i]);TRASH_FLAG=!1}else{if(getSum(TEMP_DATA)>0&&"temp"==$(".tab-pane.active").attr("id")&&-1==$.inArray($("#temp").attr("mode"),["excrete","pee","poo","spew"])&&!confirm("仍有物品未拾取，确定返回？"))return;if(getSum(TRADE_GIVE)>0&&"trade"==$(".tab-pane.active").attr("id")&&!confirm("请取回你展示在商队面前的物品，难道你想免费送给他们吗？"))return}for(i in TEMP_DATA)if(ITEM_DATA[i].important)return void alert("存在重要物品，不可丢弃，请取回。");clear(TEMP_DATA),EX_RESOURCE="",toLoading(.1,EX_TAB[EX_TAB.length-1],"back")},layer.append(newBtn),layer.append("<br>")}function toLoading(time,dest,stay,callback){function generate(){var newObj,i,newItem,buff;switch(dest){case"excrete":case"spew":case"pickUp":case"resource":case"trash":case"output":newObj=new tempObj(dest),newObj.create();break;case"poo":updateStatus("hunger",-8),EXCRETE_FLAG[0]=!1,EXCRETE_TIME[0]=clone(sysTime),removeBuff("shitReady"),"toilet"==EX_TAB[EX_TAB.length-1]?(TOILET_DATA.shit=void 0==TOILET_DATA.shit?0:TOILET_DATA.shit,caculate(TOILET_DATA,"shit",4),newObj=new mapObj("toilet"),newObj.create()):(clear(TEMP_DATA),TEMP_DATA.shit=4,newObj=new tempObj(dest),newObj.create());break;case"pee":updateStatus("thirst",-5),EXCRETE_FLAG[1]=!1,EXCRETE_TIME[1]=clone(sysTime),removeBuff("urineReady"),"toilet"==EX_TAB[EX_TAB.length-1]?(TOILET_DATA.urine=void 0==TOILET_DATA.urine?0:TOILET_DATA.urine,caculate(TOILET_DATA,"urine",5),newObj=new mapObj("toilet"),newObj.create()):(clear(TEMP_DATA),TEMP_DATA.urine=5,newObj=new tempObj(dest),newObj.create());break;case"work":case"tech":case"lab":case"handwork":case"bed":case"cook":case"forge":case"filter":case"train":newObj=new workbenchObj(dest),newObj.create();break;case"battle":BATTLE_OBJ.create(),BATTLE_OBJ.play();break;case"quest":break;case"trade":tradeCreate(),tradeCheck();break;case"box":if($("#box .item").length!=getSum(BOX_DATA))for(i in BOX_DATA)void 0!=$("#box .item[id='"+i+"']").attr("id")&&$("#box .item[id='"+i+"']").remove(),newItem=new itemObj(i,$("#box")),newItem.create();break;default:$("#map").attr("place")!=dest&&(buff=MAP_DATA[$("#map").attr("place")].buff,(void 0==MAP_DATA[dest].buff||MAP_DATA[dest].buff!=buff)&&(removeBuff(buff),void 0!=PLAYER_STATUS.buffPause[buff]&&delete PLAYER_STATUS.buffPause[buff])),"outside"==dest&&tradeGenerate(),newObj=new mapObj(dest),newObj.create()}}function toNext(){var newObj,nextTab=$(".tab-pane.active").attr("id"),nextName="";switch(dest){case"work":case"tech":case"lab":case"handwork":case"bed":case"cook":case"forge":case"filter":case"train":nextTab="workbench",nextName=WORK_TAB_NAME[dest];break;case"battle":nextTab="battle",nextName="战斗";break;case"pickUp":case"output":nextTab="temp",nextName="拾取";break;case"excrete":nextTab="temp",nextName="强制排泄(噫~)";break;case"spew":nextTab="temp",nextName="呕吐";break;case"poo":case"pee":"toilet"==EX_TAB[EX_TAB.length-1]?(EX_TAB.pop(),nextTab="map",newObj=new mapObj("toilet"),nextName=newObj.name):(nextTab="temp",nextName="排泄物");break;case"resource":nextTab="temp",nextName="获取资源";break;case"trash":nextTab="temp",nextName="垃圾",TRASH_FLAG=!0;break;case"quest":nextTab="quest";break;case"trade":nextTab="trade",nextName="旅行商队";break;case"box":nextTab="box",nextName="箱子<span id='boxCap'></span>";break;default:nextTab="map",newObj=new mapObj(dest),nextName=newObj.name,BATTLE_ATONCE&&(BATTLE_ATONCE=!1,nextTab="battle",nextName="战斗",BATTLE_OBJ.create(),BATTLE_OBJ.play())}nextTab!=$(".tab-pane.active").attr("id")&&$("#tablist a[href='#"+nextTab+"']").tab("show"),""!=nextName&&($("#mainTitle").html(nextName),"farm"==dest&&getSum(MAP_DATA.farm.resource),"box"==dest&&getSum(BOX_DATA)),$("#overlay").fadeOut(300,remove)}function remove(){$("#loading").empty(),null!=callback&&callback()}var autoflag,loadDiv,bar;LOAD_FLAG||DEATH_FLAG||(autoflag=!1,"outside"==dest&&"map"==$(".tab-pane.active").attr("id")&&"home"==$("#map").attr("place")&&(autoflag=!0,DISASTER_EFFECT&&(sysTime-DISASTER_LASTTIME)/1e3/60>=DISASTER_TIME&&getBuff(DISASTER)),"home"==dest&&"map"==$(".tab-pane.active").attr("id")&&(autoflag=!0,removeBuff("sandstorm"),removeBuff("rain")),autoflag&&autosave(),SAVE_FAST&&""!=SAVE_KEY&&"home"==dest&&void 0==$("#fastsave").attr("id")?($("#pauseBtn").before(newElement("button","fastsave","","btn btn-default","快速保存(F6)")),$("#fastsave").click(function(){$("#fastsave").html("保存中..."),$("#fastsave").attr("disabled","disabled"),save(!0,SAVE_KEY)})):void 0!=$("#fastsave").attr("id")&&$("#fastsave").remove(),$("#info").empty(),$(".item").popover("destroy"),null==stay?getNowTab():"back"==stay&&EX_TAB.pop(),EX_TAB[EX_TAB.length-1]==EX_TAB[EX_TAB.length-2]&&EX_TAB.pop(),$("#overlay").height(document.body.clientHeight),$("#overlay").width(document.body.clientWidth),$("#overlay").fadeTo(100,0),time>=.5?($("#tablist a[href='#loading']").tab("show"),loadDiv=document.createElement("div"),loadDiv.className="loadDiv",bar=document.createElement("div"),bar.className="loadingBar",loadDiv.appendChild(bar),$("#loading").append(loadDiv),$("#loading div div").animate({width:"100%"},1e3*time,toNext),setTimeout(generate,300)):(generate(),toNext()))}function getNowTab(){var activeTab=$(".tab-pane.active").attr("id");-1!=$.inArray(activeTab,["map","workbench","box"])&&("map"==activeTab?EX_TAB.push($("#map").attr("place")):"workbench"==activeTab?EX_TAB.push($("#workbench").attr("mode")):EX_TAB.push($(".tab-pane.active").attr("id")))}function getSum(belong){var i,sum=Object.getOwnPropertyNames(belong).length;switch(belong){case BAG_DATA:for(i in BAG_DATA)ITEM_DATA[i].volume&&(sum-=1);$("#bagCap").text(sum+"/"+BAG_CAP);break;case BOX_DATA:$("#boxCap").text(sum+"/"+BOX_CAP);break;case MAP_DATA.farm.resource:$("#farmCap").text(sum+"/"+FARM_CAP)}return sum}function autosort(holder){function compare(name,minor){return function(o,p){var a,b;return o&&p&&"object"==typeof o&&"object"==typeof p?(a=o[name],b=p[name],a===b?"function"==typeof minor?minor(o,p):0:typeof a==typeof b?a>b?-1:1:typeof a>typeof b?-1:1):void 0}}var temp,order,layer,i,index,j,newObj;$(".item").popover("destroy"),temp=[],order=["food","material","tool","quest","foot","body","head","ammo","weapon"],layer=holder==BAG_DATA?$("#bag"):$("#box");for(i in holder){index=$.inArray(ITEM_DATA[i].type,order);for(j in PLAYER_STATUS.equip)if(PLAYER_STATUS.equip[j]==i&&holder==BAG_DATA){index=99;break}temp.push({id:i,order:index})}temp.sort(compare("order",compare("id"))),layer.find(".item").remove();for(i in temp)newObj=new itemObj(temp[i].id,layer),newObj.create()}function min(array,mode){var i,own,a=9999999,b="";for(i in array)own=(void 0==BAG_DATA[i]?0:BAG_DATA[i])+(void 0==BOX_DATA[i]?0:BOX_DATA[i]),"cook"==mode&&(own=COOK_DATA[i]),own/array[i]<a&&(a=own/array[i],b=i);return[a,b]}function updateSysClock(min,sec,flag,stepval){var hh,mm,day,countdown,step=stepval;sysTime=new Date(sysTime.getTime()+60*min*1e3+1e3*sec),hh=(sysTime.getHours()<10?"0":"")+sysTime.getHours(),mm=(sysTime.getMinutes()<10?"0":"")+sysTime.getMinutes(),day=(sysTime-baseTime)/1e3/60/60/24+1,""==DISASTER||DISASTER_EFFECT||(countdown=DISASTER_TIME-(sysTime-DISASTER_LASTTIME)/1e3/60),DISASTER_EFFECT&&($("#countdownType").html("持续时间"),countdown=DISASTER_LAST+DISASTER_TIME-(sysTime-DISASTER_LASTTIME)/1e3/60),2==step&&($("#clock").html("第 "+Math.floor(day)+" 日  "+hh+":"+mm),void 0!=$("#countdown").attr("id")&&(countdown=countdown>=60?Math.floor(countdown/60)+"小时"+Math.floor(countdown%60)+"分钟":Math.floor(countdown)+"分钟",$("#countdown").html(countdown)),step=0),TIMER_FLAG&&flag&&setTimeout(function(){updateSysClock(1,15,!0,step+1)},500)}function updateStatus(status,value,buffer){var n,newDesc,i,newObj;if(!LOAD_FLAG){if(null!=value){switch(buffer?(void 0==PLAYER_STATUS[status].buffer&&(PLAYER_STATUS[status].buffer=0),caculate(PLAYER_STATUS[status],"buffer",parseFloat(value))):caculate(PLAYER_STATUS[status],"value",parseFloat(value)),status){case"life":realVal(status)<=0&&!DEATH_FLAG&&death();break;case"hunger":hungerChk();break;case"thirst":thirstChk();break;case"energy":PLAYER_STATUS.energy.value<-10&&getBuff("overwork");break;case"san":sanChk();break;case"radiation":0>value&&(PLAYER_STATUS.radiation.value<=75&&(removeBuff("longleg"),removeBuff("eagle")),PLAYER_STATUS.radiation.value<=40&&(removeBuff("hulk"),removeBuff("stonelike")),PLAYER_STATUS.radiation.value<=0&&(removeBuff("ugly"),removeBuff("slow_1")));break;case"tech":n=0,newDesc="<span style='color:#000;'>";for(i in TOOL_DATA)if(void 0!=TOOL_DATA[i].tech&&PLAYER_STATUS.tech.value>=TOOL_DATA[i].tech&&void 0==TOOL_DATA[i].show&&-1==$.inArray(i,TOOL_FINISHED)){if(void 0!=TOOL_DATA[i].level&&TOOL_DATA[i].level>TOOL_LEVEL[TOOL_DATA[i].type[0]])continue;4>=n&&(n>0&&(newDesc+="、"),newDesc+="["+TOOL_DATA[i].name+"]"),TOOL_DATA[i].show=!0,TOOL_DATA[i].newflag=!0,n+=1}newDesc+="</span>",n>0&&showMsg("技术提升，解锁了 "+newDesc+" 等新的制造物和科技，请留意查看。")}void 0!=PLAYER_STATUS[status].max&&PLAYER_STATUS[status].value>PLAYER_STATUS[status].max&&(PLAYER_STATUS[status].value=clone(PLAYER_STATUS[status].max)),void 0!=PLAYER_STATUS[status].min&&PLAYER_STATUS[status].value<PLAYER_STATUS[status].min&&(PLAYER_STATUS[status].value=clone(PLAYER_STATUS[status].min))}(-1==$.inArray(status,STATUS_LIST)||"radiation"==status)&&gameSet(),newObj=new statusObj(status),newObj.update()}}function nextProgress(status){return(PLAYER_STATUS[status].value+1)*PLAYER_STATUS[status].value*5+50}function updateProgress(status,value){LOAD_FLAG||null!=value&&void 0!=PLAYER_STATUS[status].progerss&&(caculate(PLAYER_STATUS[status],"progerss",value),PLAYER_STATUS[status].progerss>=nextProgress(status)&&(caculate(PLAYER_STATUS[status],"progerss",-nextProgress(status)),updateStatus(status,1)))}function updateItem(id,belong){var i,percent,sum,amount,volume,itemType,layer=belong[0].getAttribute("name"),holder=getHolder(belong[0]),name=ITEM_DATA[id].name;for(i in PLAYER_STATUS.equip)if(PLAYER_STATUS.equip[i]==id&&"bag"==layer){name="<span class='noneBuffName'>["+name+"]</span>";break}if(void 0!=ITEM_DATA[id].durab?(percent=holder[id]%ITEM_DATA[id].durab/ITEM_DATA[id].durab*100,percent=0==percent?100:percent,sum=Math.ceil(holder[id]/ITEM_DATA[id].durab),amount="<div class='durabDiv'><div class='loadingBar' style='width:"+percent+"%;'></div></div><br>"+sum,belong.find(".item[id = "+id+"]").html(name+amount)):(volume="",void 0!=ITEM_DATA[id].volume&&"bag"==layer&&(volume="/",volume+=(Math.ceil(holder[id]/KETTLE_VOLUME)*KETTLE_VOLUME).toString()),belong.find(".item[id = "+id+"]").html(name+"<br>"+holder[id]+volume)),holder[id]<=0){for(i in PLAYER_STATUS.equip){if(PLAYER_STATUS.equip[i]==id&&"bag"==layer){if(itemType=void 0!=ITEM_DATA[id].attack?"weapon":ITEM_DATA[id].type,PLAYER_STATUS.equip[itemType]="",void 0!=ITEM_DATA[id].attack&&updateStatus("attack",-ITEM_DATA[id].attack,!0),-1!=$.inArray(ITEM_DATA[id].type,["head","body","foot"])&&void 0!=ITEM_DATA[id].buffUse&&removeBuff(ITEM_DATA[id].buffUse),void 0!=ITEM_DATA[id].effect)for(i in ITEM_DATA[id].effect)updateStatus(i,-ITEM_DATA[id].effect[i],!0);"battle"==$(".tab-pane.active").attr("id")&&(BATTLE_OBJ.resetPlayer(),BATTLE_OBJ.setValue())}break}$(".item").popover("destroy"),$("#info").empty(),belong.find(".item[id = "+id+"]").remove(),void 0!=ITEM_DATA[id].buffPick&&"bag"==layer&&(removeBuff(ITEM_DATA[id].buffPick),PLAYER_STATUS.buffPause[ITEM_DATA[id].buffPick]&&delete PLAYER_STATUS.buffPause[ITEM_DATA[id].buffPick]),delete holder[id]}NaNcheck(holder),getSum(holder)}function newElement(type,id,name,className,innerHTML){var newElement=document.createElement(type);return newElement.id=id,newElement.setAttribute("name",name),newElement.className=className,newElement.innerHTML=innerHTML,newElement}function pauseGame(){TIMER_FLAG=!1}function resumeGame(){DEATH_FLAG||TIMER_FLAG||(TIMER_FLAG=!0,updateSysClock(1,15,!0,1),tick())}function getBuff(buff){var i,info,buffer,status,value,flag=1;if(void 0==PLAYER_STATUS.buff[buff]){for(i in PLAYER_STATUS.buff)void 0!=BUFF_DATA[i].clearBuff&&-1!=buff.indexOf(BUFF_DATA[i].clearBuff)&&(flag=0,PLAYER_STATUS.buffPause[buff]=!0);if(flag){if(PLAYER_STATUS.buff[buff]=[clone(sysTime),clone(sysTime)],BUFF_DATA[buff].cost&&(PLAYER_STATUS.buff[buff][1]=new Date(sysTime.getTime()-1e3*BUFF_DATA[buff].interval*60)),void 0!=BUFF_DATA[buff].name&&(info="<br><span class='"+BUFF_DATA[buff].type+"BuffName'>"+BUFF_DATA[buff].name+"</span>："+BUFF_DATA[buff].desc,PLAYER_STATUS[BUFF_DATA[buff].on].desc.indexOf(info)<0&&(PLAYER_STATUS[BUFF_DATA[buff].on].desc+=info)),void 0!=BUFF_DATA[buff].effect&&(BUFF_DATA[buff].temp||BUFF_DATA[buff].atonce)){buffer=BUFF_DATA[buff].temp?!0:null;for(i in BUFF_DATA[buff].effect)void 0!=BUFF_DATA[buff].effect[i].percent?(status=BUFF_DATA[buff].effect[i].type,value=realVal(i),status!=i&&(value=realVal(status)),value*=BUFF_DATA[buff].effect[i].percent,updateStatus(i,value,buffer)):updateStatus(i,BUFF_DATA[buff].effect[i],buffer)}if(void 0!=BUFF_DATA[buff].clearBuff)for(i in PLAYER_STATUS.buff)-1!=i.indexOf(BUFF_DATA[buff].clearBuff)&&removeBuff(i);void 0!=BUFF_DATA[buff].on&&updateStatus(BUFF_DATA[buff].on)}}}function removeBuff(buff){var info,str,a,times,j,i,status,value;if(void 0!=PLAYER_STATUS.buff[buff]){if(void 0!=BUFF_DATA[buff].name&&(info="<br><span class='"+BUFF_DATA[buff].type+"BuffName'>"+BUFF_DATA[buff].name+"</span>："+BUFF_DATA[buff].desc,str=PLAYER_STATUS[BUFF_DATA[buff].on].desc,PLAYER_STATUS[BUFF_DATA[buff].on].desc=str.replace(info,"")),void 0!=BUFF_DATA[buff].effect&&BUFF_DATA[buff].temp){for(a=Object.keys(BUFF_DATA[buff].effect),times=void 0!=BUFF_DATA[buff].interval?PLAYER_STATUS.buff[buff][2]+1:1,j=0;times>j;j++)for(i=a.length-1;i>-1;i--)void 0!=BUFF_DATA[buff].effect[a[i]].percent?(status=BUFF_DATA[buff].effect[a[i]].type,value=realVal(a[i])*(BUFF_DATA[buff].effect[a[i]].percent/(1+BUFF_DATA[buff].effect[a[i]].percent)),status!=a[i]&&(value=realVal(status)*BUFF_DATA[buff].effect[a[i]].percent),updateStatus(a[i],-value,!0)):updateStatus(a[i],-BUFF_DATA[buff].effect[a[i]],!0);for(i in PLAYER_STATUS.equip)if(""!=PLAYER_STATUS.equip[i]&&void 0!=ITEM_DATA[PLAYER_STATUS.equip[i]].require)for(j in ITEM_DATA[PLAYER_STATUS.equip[i]].require)if(realVal(j)<ITEM_DATA[PLAYER_STATUS.equip[i]].require[j]){$("#bag .item[id='"+PLAYER_STATUS.equip[i]+"']").trigger("selfUnload");break}}if(delete PLAYER_STATUS.buff[buff],void 0!=BUFF_DATA[buff].clearBuff)for(i in PLAYER_STATUS.buffPause)PLAYER_STATUS.buffPause[i]&&-1!=i.indexOf(BUFF_DATA[buff].clearBuff)&&(delete PLAYER_STATUS.buffPause[i],getBuff(i));void 0!=BUFF_DATA[buff].on&&updateStatus(BUFF_DATA[buff].on)}}function showMsg(msg,time){function closeMsg(){void 0!=$("#message")&&$("#message").alert("close")}var newDiv,newBtn,delay;void 0!=$("#message")&&$("#message").remove(),newDiv=newElement("div","message","","alert alert-info alert-dismissible message",""),newDiv.setAttribute("role","alert"),newBtn=newElement("button","","","close","<span aria-hidden='true'>&times;</span>"),newBtn.setAttribute("data-dismiss","alert"),newBtn.setAttribute("aria-label","Close"),newDiv.appendChild(newBtn),newDiv.innerHTML+=msg,$("#background").append(newDiv),$("#message").hide(),delay=void 0==time?5e3:time,$("#message").fadeIn(500,function(){$("#message").addClass("fade in")}).delay(delay).fadeOut(500,closeMsg),$("#message").offset({left:$("#info").offset().left,top:$("#info").offset().top})}function showAD(pos){var newDiv,newBtn,className="alert alert-info alert-dismissible";return null!=pos&&(className+=" "+pos),newDiv=newElement("div","adsense","",className,""),newDiv.setAttribute("role","alert"),newBtn=newElement("button","","","close","<span aria-hidden='true'>&times;</span>"),newBtn.setAttribute("data-dismiss","alert"),newBtn.setAttribute("aria-label","Close"),newDiv.appendChild(newBtn),newDiv.innerHTML+=GGAD,newDiv}function placeDesc(data){var i,j,result="";if(void 0!=data.resource&&getSum(data.resource)>0){result+="资源：";for(i in data.resource)data.resource[i].hide||(result+="["+data.resource[i].name+"] ");result+="<br>"}if(void 0!=data.trash&&getSum(data.trash)>0){result+="垃圾：";for(i in data.trash)result+="["+ITEM_DATA[i].name+"] ";result+="<br>"}if(void 0!=data.enemy&&(void 0!=data.enemy.normal||void 0!=data.enemy.boss)){result+="生物：";for(i in data.enemy.normal)result+="["+CREEP_DATA[i].name.replace("<br>","")+"] ";if(void 0!=data.enemy.boss)for(j in data.enemy.boss)"name"!=j&&"rate"!=j&&(result+="["+CREEP_DATA[j].name.replace("<br>","")+"] ")}if(void 0!=data.place&&getSum(data.place)>0)for(i in data.place)data.place[i].enemy&&(result+="["+CREEP_DATA[i].name.replace("<br>","")+"] ");return result}function amountDesc(a){var i,b=["几个","少量","一般","很多","大量","丰富"];for(i in b)if(15*i+5>=a)return b[i];return b[5]}function densityDesc(a){var i,density=(MAP_DATA[a].enemy.get[1]+MAP_DATA[a].enemy.get[0])/2,b=["几个","稀疏","中等","较多","密集","海量！"];for(i in b)if(i+1>=density)return b[i];return b[5]}function chanceDesc(a){var i,b=["极低","很低","较低","一般","较高","很高","极高","必然"];for(i in b)if(15*i+10>a)return b[i];return b[7]}function clone(a){var b,i;switch(typeof a){case"object":if(a instanceof Array){b=[];for(i in a)b.push(clone(a[i]))}else if(a instanceof Date)b=new Date(a);else{b={};for(i in a)b[i]=clone(a[i])}break;case"number":b=a+0;break;case"string":b=a+"";break;case"undefined":break;default:b=a}return b}function clear(a){for(var i in a)delete a[i]}function caculate(data,name,value){void 0==data[name]||isNaN(data[name])||void 0==value||isNaN(value)||(data[name]+=value)}function realVal(status){var val=clone(PLAYER_STATUS[status].value);return void 0!=PLAYER_STATUS[status].buffer&&(val+=PLAYER_STATUS[status].buffer),void 0!=PLAYER_STATUS[status].max&&val>PLAYER_STATUS[status].max&&(val=clone(PLAYER_STATUS[status].max)),void 0!=PLAYER_STATUS[status].min&&val<PLAYER_STATUS[status].min&&(val=clone(PLAYER_STATUS[status].min)),val}function taphold(obj,func){var taptime;obj.ontouchstart=function(){taptime=setTimeout(function(){TAPHOLD_FLAG=!0,func.call(obj)},500)},obj.ontouchend=function(){TAPHOLD_FLAG=!1,clearTimeout(taptime)},obj.ontouchmove=function(){TAPHOLD_FLAG=!1,clearTimeout(taptime)},obj.ontouchcancel=function(){TAPHOLD_FLAG=!1,clearTimeout(taptime)}}function randomUnicode(){var result;return eval("result = '\\u"+Math.floor(9664*Math.random()+26159).toString(16)+"';"),result}function saveData(){var data,i,j,k,l;try{data={};for(i in SAVE_LIST)data[SAVE_LIST[i]]=eval("clone("+SAVE_LIST[i]+");");for(i in data.PLAYER_STATUS)for(j in data.PLAYER_STATUS[i])"value"==j&&Math.ceil(data.PLAYER_STATUS[i][j])!==data.PLAYER_STATUS[i][j]&&-1==$.inArray(i,["critical","critimes","dodge","hitrate","escape","tech"])&&(data.PLAYER_STATUS[i][j]=Math.ceil(data.PLAYER_STATUS[i][j])),-1!=$.inArray(j,["name","desc","percent","overflow"])&&delete data.PLAYER_STATUS[i][j];for(i in data.MAP_DATA)if(void 0==EXPLORE_DATA[i])for(j in data.MAP_DATA[i]){"resource"!=j&&"trash"!=j&&"enemy"!=j&&("place"!=j||"outside"!=i)&&delete data.MAP_DATA[i][j];for(k in data.MAP_DATA[i][j]){"place"==j&&"outside"==i&&void 0==EXPLORE_DATA[k]&&delete data.MAP_DATA[i][j][k],"enemy"==j&&"normal"!=k&&delete data.MAP_DATA[i][j][k],"trash"==j&&delete data.MAP_DATA[i][j][k].get;for(l in data.MAP_DATA[i][j][k])"farm"!=i&&"resource"==j&&"value"!=l&&delete data.MAP_DATA[i][j][k][l]}}return data=timeTrans(data),JSON.stringify(data)}catch(e){return!1}}function autosave(){var data=saveData();data?void 0!=window.localStorage&&localStorage.setItem("autosave",escape(data)):alert("存档文件生成失败。")}function loadData(data){var json,i,info,j,clockMsg,newObj;try{json=JSON.parse(data),json=timeTrans(json)}catch(e){return!1}LOAD_FLAG=!0;for(i in json)switch(typeof json[i]){case"object":json[i]instanceof Array?eval(i+" = clone(json[i]);"):json[i]instanceof Date?eval(i+" = clone(json[i]);"):eval(i+" = $.extend(true, {}, "+i+", clone(json[i]));");break;default:eval(i+" = clone(json[i]);")}PLAYER_STATUS.critimes.value=1.5,PLAYER_STATUS.hitrate.value=100;for(i in TOOL_DATA)void 0!=TOOL_DATA[i].tech&&PLAYER_STATUS.tech.value>=TOOL_DATA[i].tech&&void 0==TOOL_DATA[i].show&&(TOOL_DATA[i].show=!0);for(i in TOOL_FINISHED)void 0!=TOOL_DATA[TOOL_FINISHED[i]]&&(void 0!=TOOL_DATA[TOOL_FINISHED[i]].upgrade&&eval(TOOL_DATA[TOOL_FINISHED[i]].upgrade),TOOL_DATA[TOOL_FINISHED[i]].newflag&&delete TOOL_DATA[TOOL_FINISHED[i]].newflag,delete TOOL_DATA[TOOL_FINISHED[i]].show);for(i in QUEST_FINISHED)void 0!=QUEST_DATA[QUEST_FINISHED[i][0]]&&(void 0!=QUEST_DATA[QUEST_FINISHED[i][0]].update&&void 0==QUEST_DATA[QUEST_FINISHED[i][0]].dontload&&eval(QUEST_DATA[QUEST_FINISHED[i][0]].update),"null"!=QUEST_FINISHED[i][1]&&eval("MAP_DATA."+QUEST_FINISHED[i][1]+".quest.shift();"));for(i in PLAYER_STATUS.buff)void 0!=BUFF_DATA[i].name&&(info="<br><span class='"+BUFF_DATA[i].type+"BuffName'>"+BUFF_DATA[i].name+"</span>："+BUFF_DATA[i].desc,PLAYER_STATUS[BUFF_DATA[i].on].desc.indexOf(info)<0&&(PLAYER_STATUS[BUFF_DATA[i].on].desc+=info));for(i in MAP_DATA)if(0==i.indexOf("explore_")&&void 0!=EXPLORE_DATA[i]&&void 0==MAP_DATA.outside.place[i]&&(delete MAP_DATA[i],delete EXPLORE_DATA[i]),void 0!=MAP_DATA[i].trash)for(j in MAP_DATA[i].trash)void 0==MAP_DATA[i].trash[j].get&&delete MAP_DATA[i].trash[j];delete MAP_DATA.vault7.enemy.normal.ghoul_1,delete MAP_DATA.vault7.enemy.normal.ghoul_2,EXPLORE_CHECK=clone(sysTime),DISASTER_CHECK=clone(sysTime),disasterChk(),""!=DISASTER&&void 0==$("#disasterInfo").attr("id")&&(clockMsg="<span id='disasterInfo' class='disasterInfo'>"+DISASTER_TYPE[DISASTER].name+" <span id='countdownType'>倒计时</span>：<span id='countdown'></span></span>",$("#clock").popover({html:!0,trigger:"click",title:clockMsg}),$("#clock").popover("show")),resInit(MAP_DATA),cookCheck(),gameSet(),$("#bag").empty();for(i in BAG_DATA)newObj=new itemObj(i,$("#bag")),newObj.create();return autosort(BAG_DATA),getSum(BAG_DATA),BEGINNER_FLAG&&(ITEM_DATA.meat.effect={hunger:10,radiation:1},ITEM_DATA.roachMeat.effect={hunger:8,radiation:1},ITEM_DATA.wormMeat.effect={hunger:8,radiation:1},BUFF_DATA.sandstorm.interval=15,BUFF_DATA.rain.interval=15,$("#clock").after(newElement("div","beginnerFlag","","","新手模式"))),LOAD_FLAG=!1,USERNAME="",toLoading(.1,"home"),!0}function fixsave(){var i,bufferSum,j,effect,k,times,status,value;for(i in PLAYER_STATUS)if(-1==$.inArray(i,["tech","buff","buffPause","equip"])){bufferSum=0;for(j in PLAYER_STATUS.equip){if(""!=PLAYER_STATUS.equip[j]&&void 0!=ITEM_DATA[PLAYER_STATUS.equip[j]].effect){effect=ITEM_DATA[PLAYER_STATUS.equip[j]].effect;for(k in effect)k==i&&(bufferSum+=effect[k])}""!=PLAYER_STATUS.equip[j]&&"weapon"==j&&"attack"==i&&(bufferSum+=ITEM_DATA[PLAYER_STATUS.equip[j]].attack)}for(j in PLAYER_STATUS.buff)if(void 0!=BUFF_DATA[j].effect&&BUFF_DATA[j].temp)for(k in BUFF_DATA[j].effect)k==i&&(times=1,void 0!=PLAYER_STATUS.buff[j][2]&&(times=PLAYER_STATUS.buff[j][2]),void 0!=BUFF_DATA[j].effect[k].percent?(status=BUFF_DATA[j].effect[k].type,value=realVal(k),status!=k&&(value=realVal(status)),value*=BUFF_DATA[j].effect[k].percent,bufferSum+=value):bufferSum+=BUFF_DATA[j].effect[k]);void 0!=PLAYER_STATUS[i].buffer&&PLAYER_STATUS[i].buffer!=bufferSum?(PLAYER_STATUS[i].buffer=bufferSum,0!=bufferSum&&PLAYER_STATUS[i].value!=PLAYER_STATUS_INIT[i].value&&(PLAYER_STATUS[i].value=PLAYER_STATUS_INIT[i].value-bufferSum)):void 0==PLAYER_STATUS[i].buffer&&0!=bufferSum&&(PLAYER_STATUS[i].buffer=bufferSum,PLAYER_STATUS[i].value!=PLAYER_STATUS_INIT[i].value&&(PLAYER_STATUS[i].value=PLAYER_STATUS_INIT[i].value-bufferSum))}}function NaNcheck(data){for(var i in data)isNaN(data[i])&&delete data[i]}function timeTrans(a){var b,i;switch(typeof a){case"object":if(a instanceof Array){b=[];for(i in a)b.push(timeTrans(a[i]))}else if(a instanceof Date)b=a.getTime();else{b={};for(i in a)b[i]=timeTrans(a[i])}break;case"number":b=13==a.toString().length?new Date(a):a+0;break;case"string":b=a+"";break;case"undefined":break;default:b=a}return b}function beforeGameObj(){function roleBuild(){var i,tip,names,values,tdName,tdValue,minusBtn,plusBtn,tb,thead,tbody,beginner;freePoint=2,points=[],ranSum=0;for(i in SPECIAL_LIST)points[i]=Math.random(),ranSum+=points[i];for(i in SPECIAL_LIST)points[i]=2+Math.round(12*points[i]/ranSum);$("#beforeGame").empty(),$("#beforeGame").append("<div id='buildDiv'></div>"),tip="自由属性点:<span>"+freePoint+"</span><br>点击分配",$("#buildDiv").append(newElement("div","pointInfo","","",tip)),names=newElement("tr","","","",""),values=newElement("tr","values","","","");for(i in SPECIAL_LIST)tdName=newElement("td",SPECIAL_LIST[i],"","",PLAYER_STATUS[SPECIAL_LIST[i]].name),tdName.onmouseover=function(){showinfo.call(this)},tdName.ontouchstart=tdName.onmouseover,names.appendChild(tdName),tdValue=newElement("td",SPECIAL_LIST[i],"","",""),tdValue.onmouseover=function(){showinfo.call(this)},tdValue.ontouchstart=tdValue.onmouseover,minusBtn=newElement("button",SPECIAL_LIST[i],"","btn btn-default","-"),minusBtn.onclick=function(){minusPoint.call(this)},plusBtn=newElement("button",SPECIAL_LIST[i],"","btn btn-default","+"),plusBtn.onclick=function(){addPoint.call(this)},tdValue.appendChild(minusBtn),tdValue.appendChild(newElement("span","","","",points[i])),tdValue.appendChild(plusBtn),values.appendChild(tdValue);tb=newElement("table","","","table",""),thead=document.createElement("thead"),tbody=document.createElement("tbody"),thead.appendChild(names),tbody.appendChild(values),tb.appendChild(thead),tb.appendChild(tbody),$("#buildDiv").append(tb),applyPoint(),beginner=newElement("input","","","beginner",""),beginner.type="checkbox",beginner.onmouseover=function(){$("#buildDiv div[class='info']").html("饥饿、干渴速度减慢，不会获取大部分负面效果，降低部分惩罚。")},$("#buildDiv").append(beginner),$("#buildDiv").append("新手模式"),$("#buildDiv").append("<div class='info'>鼠标置于属性名上查看说明</div>"),$("#buildDiv").append(newElement("button","","confirm","btn btn-default","确认")),$("#buildDiv").append(newElement("button","","reroll","btn btn-default","重置")),$("#buildDiv button[name='confirm']").click(function(){confirm("确认使用此套属性点进行游戏吗？")&&(freePoint>0?alert("仍有属性点未分配。"):(applyPoint(),$("#buildDiv .beginner").is(":checked")&&(BEGINNER_FLAG=!0,delete TOOL_DATA.compass.show,eval(TOOL_DATA.cook_rad.upgrade),eval(TOOL_DATA.lantern.upgrade),delete TOOL_DATA.cook_rad.tech,delete TOOL_DATA.lantern.show,TOOL_FINISHED.push("cook_rad"),TOOL_FINISHED.push("lantern"),ITEM_DATA.meat.effect={hunger:10,radiation:1},ITEM_DATA.roachMeat.effect={hunger:8,radiation:1},ITEM_DATA.wormMeat.effect={hunger:8,radiation:1},BUFF_DATA.sandstorm.interval=15,BUFF_DATA.rain.interval=15),$("#beforeGame").fadeOut(1e3,function(){$("#beforeGame").remove(),startGame(),updateSysClock(2,0,!1,2),resumeGame()})))}),$("#buildDiv button[name='reroll']").click(function(){reroll()}),$("#beforeGame").fadeIn(500)}function showinfo(){$("#buildDiv div[class='info']").html(PLAYER_STATUS[this.id].desc)}function reroll(){var i;freePoint=2,points=[],ranSum=0;for(i in SPECIAL_LIST)points[i]=Math.random(),ranSum+=points[i];for(i in SPECIAL_LIST)points[i]=2+Math.round(12*points[i]/ranSum),$("#buildDiv #values td:eq("+i+") span").html(points[i]);applyPoint(),$("#pointInfo span").html(freePoint)}function minusPoint(){var value=parseInt($("#buildDiv #values #"+this.id+" span").html());2>freePoint&&value>PLAYER_STATUS[this.id].value&&($("#buildDiv #values #"+this.id+" span").html(value-1),freePoint+=1,$("#pointInfo span").html(freePoint))}function addPoint(){if(freePoint>0){var value=parseInt($("#buildDiv #values #"+this.id+" span").html());$("#buildDiv #values #"+this.id+" span").html(value+1),freePoint-=1,$("#pointInfo span").html(freePoint)}}function applyPoint(){for(var i in SPECIAL_LIST)PLAYER_STATUS[SPECIAL_LIST[i]].value=parseInt($("#buildDiv #values #"+SPECIAL_LIST[i]+" span").html())}var freePoint=2,points=[],ranSum=0;this.create=function(){$("div[class='container-fluid']").append(newElement("div","beforeGame","","","")),$("#beforeGame").append("<p></p>"),$("#beforeGame p").append(newElement("button","newPlay","","btn btn-default","新建")),$("#beforeGame p").append(newElement("button","load","","btn btn-default","读取"));var savecookie;void 0!=window.localStorage&&(savecookie=localStorage.getItem("autosave")),void 0!=savecookie&&($("#beforeGame p").append("<br>"),$("#beforeGame p").append(newElement("button","continue","","btn btn-default","继续游戏")),$("#continue").click(function(){$(this).html("读取中..."),$(this).attr("disabled","disabled"),startGame(),loadData(unescape(savecookie))?$("#beforeGame").fadeOut(1e3,function(){$("#beforeGame").remove(),resumeGame()}):($("#background").empty(),resetGame(),alert("存档文件出现问题，读取失败。")),$(this).removeAttr("disabled"),$(this).html("继续游戏")})),$("#newPlay").click(function(){$("#beforeGame").fadeOut(500,roleBuild)}),$("#load").click(function(){slView("load","beforeGame")})}}function startGame(){var i,newObj,map;createUI(),gameSet(),PLAYER_STATUS.life.value=PLAYER_STATUS.life.max,resInit(MAP_DATA);for(i in STATUS_LIST)newObj=new statusObj(STATUS_LIST[i]),newObj.create();for(i in BAG_DATA)newObj=new itemObj(i,$("#bag")),newObj.create();getSum(BAG_DATA),map=new mapObj("origin"),map.create()}function createUI(){function bagOpen(){var mainTop,height=parseFloat($("#bag").css("height").replace("px","")),newHeight=$("#bag")[0].scrollHeight+4;$("#bag").css({height:newHeight+"px"}),mainTop=parseFloat($(".main").css("top").replace("px","")),$(".main").css({top:mainTop+newHeight-height+"px"}),void 0!=$("#message")&&$("#message").offset({left:$("#info").offset().left,top:$("#info").offset().top}),$("#bagOpen").html("收起"),$("#bagTitle").unbind("click"),$("#bagTitle").click(function(){bagClose(height)})}function bagClose(oldHeight){var newHeight,mainTop,height=parseFloat($("#bag").css("height").replace("px",""));$("#bag").css({height:oldHeight+"px"}),newHeight=parseFloat($("#bag").css("height").replace("px","")),mainTop=parseFloat($(".main").css("top").replace("px","")),$(".main").css({top:mainTop+newHeight-height+"px"}),void 0!=$("#message")&&$("#message").offset({left:$("#info").offset().left,top:$("#info").offset().top}),$("#bagOpen").html("打开"),$("#bagTitle").unbind("click"),$("#bagTitle").click(bagOpen)}var TAB_LIST,i,content,newTab,footer,clock;$("#background").empty(),TAB_LIST=["map","box","workbench","battle","trade","quest","temp","loading"],$("#background").append('<ul id="tablist" role="tablist" style="display:none;">');for(i in TAB_LIST)$("#tablist").append('<a href="#'+TAB_LIST[i]+'" role="tab"></a>');document.body.clientWidth>=1024?($("#background").append('<div id="status"></div>'),$("#background").append(newElement("label","bagTitle","","frameTitle bagTitlePc",'背包<span id="bagCap"></span>')),$("#background").append(newElement("div","bag","bag","frame","")),$("#background").append(newElement("label","infoTitle","","frameTitle infoTitlePc","信息")),$("#background").append(newElement("div","info","","frame","")),$("#background").append('<hr style="clear:both;">'),$("#background").append(newElement("label","mainTitle","","frameTitle mainTitlePc","地图"))):($("#background").append('<div id="status"></div>'),$("#background").append('<hr style="clear:both;">'),$("#background").append(newElement("label","bagTitle","","frameTitle",'<span id="bagOpen">打开</span>背包<span id="bagCap"></span>')),$("#background").append(newElement("div","bag","bag","frame","")),$("#bagTitle").click(bagOpen),$("#background").append(newElement("label","infoTitle","","frameTitle","信息")),
$("#background").append(newElement("div","info","","frame","")),$("#background").append(newElement("label","mainTitle","","frameTitle","地图"))),content=newElement("div","","","tab-content main","");for(i in TAB_LIST)newTab=newElement("div",TAB_LIST[i],TAB_LIST[i],"tab-pane fade",""),0==i&&(newTab.className="tab-pane fade in active"),newTab.setAttribute("role","tabpanel"),content.appendChild(newTab);$("#background").append(content),footer=newElement("div","footer","","",""),footer.appendChild(document.createElement("hr")),clock=newElement("div","clock","","",""),clock.setAttribute("data-toggle","popover"),clock.setAttribute("data-placement","auto top"),clock.setAttribute("data-container","body"),footer.appendChild(clock),BEGINNER_FLAG&&footer.appendChild(newElement("div","beginnerFlag","","","新手模式")),footer.appendChild(newElement("button","pauseBtn","","btn btn-default","暂停")),$("#background").append(footer),$("#pauseBtn").click(function(){pauseView()}),getBackBtn($("#box"))}function gameSet(){var limit,i,newObj;PLAYER_STATUS.life.max=Math.ceil(100*(1+(realVal("endurance")-4)/20)),PLAYER_STATUS.life.toplimit=PLAYER_STATUS.life.max,limit=5,void 0!=PLAYER_STATUS.buff.slow_1&&(limit=10),PLAYER_STATUS.life.max=PLAYER_STATUS.life.toplimit-Math.floor(realVal("radiation")/limit),PLAYER_STATUS.life.value=PLAYER_STATUS.life.value<PLAYER_STATUS.life.max?PLAYER_STATUS.life.value:PLAYER_STATUS.life.max,PLAYER_STATUS.life.value<=0&&!DEATH_FLAG&&(DEATH_FOR="辐射",death()),HUNGER_SPEED=(BEGINNER_FLAG?1/45:1/18)*(1-(realVal("endurance")-4)/20),HUNGER_SPEED=0>=HUNGER_SPEED?1/440:HUNGER_SPEED,THIRST_SPEED=(BEGINNER_FLAG?1/30:1/12)*(1-(realVal("endurance")-4)/20),THIRST_SPEED=0>=THIRST_SPEED?1/300:THIRST_SPEED,WORK_TIME_COST=BEGINNER_FLAG?1.5:2.5,WORK_ENERGY_COST=BEGINNER_FLAG?1/15:.1,PLAYER_STATUS.critical.value=2.5*(realVal("luck")-4),PLAYER_STATUS.critical.value=PLAYER_STATUS.critical.value<0?0:PLAYER_STATUS.critical.value,PLAYER_STATUS.dodge.value=2*(realVal("agility")-4),PLAYER_STATUS.dodge.value=PLAYER_STATUS.dodge.value>99?99:PLAYER_STATUS.dodge.value,PLAYER_STATUS.dodge.value=PLAYER_STATUS.dodge.value<0?0:PLAYER_STATUS.dodge.value,PLAYER_STATUS.escape.value=40*(1+.2*(realVal("agility")-4)),PLAYER_STATUS.escape.value=PLAYER_STATUS.escape.value>90?90:PLAYER_STATUS.escape.value,PLAYER_STATUS.escape.value=PLAYER_STATUS.escape.value<0?0:PLAYER_STATUS.escape.value,BATTLE_OBJ.resetPlayer();for(i in STATUS_LIST)newObj=new statusObj(STATUS_LIST[i]),newObj.update()}function pauseView(){function showinfo(){$("#pauseDiv div[class='info']").html(PLAYER_STATUS[this.id].desc)}var names,values,i,tdName,tdValue,tb,tbody,value,span;pauseGame(),$("#overlay").fadeTo(10,.5),$("#pauseDiv").fadeIn(500),names=newElement("tr","","","",""),values=newElement("tr","values","","","");for(i in SPECIAL_LIST)tdName=newElement("td",SPECIAL_LIST[i],"","",PLAYER_STATUS[SPECIAL_LIST[i]].name),tdName.onmouseover=function(){showinfo.call(this)},tdName.ontouchstart=tdName.onmouseover,names.appendChild(tdName),tdValue=newElement("td",SPECIAL_LIST[i],"","",Math.floor(realVal(SPECIAL_LIST[i]))),tdValue.onmouseover=function(){showinfo.call(this)},tdValue.ontouchstart=tdValue.onmouseover,values.appendChild(tdValue);tb=newElement("table","","","table specialTb",""),tbody=document.createElement("tbody"),tbody.appendChild(names),tbody.appendChild(values),tb.appendChild(tbody),$("#pauseDiv").append(tb),names=newElement("tr","","","",""),values=newElement("tr","values","","","");for(i in PLAYER_STATUS)-1==$.inArray(i,["equip","buff","buffPause"])&&-1==$.inArray(i,STATUS_LIST)&&-1==$.inArray(i,SPECIAL_LIST)&&(tdName=newElement("td",i,"","",PLAYER_STATUS[i].name),tdName.onmouseover=function(){showinfo.call(this)},tdName.ontouchstart=tdName.onmouseover,names.appendChild(tdName),value=realVal(i),value="tech"==i||"critimes"==i?value.toFixed(1):Math.round(value),PLAYER_STATUS[i].percent&&(value+="%"),tdValue=newElement("td",i,"","",value),tdValue.onmouseover=function(){showinfo.call(this)},tdValue.ontouchstart=tdValue.onmouseover,values.appendChild(tdValue));tb=newElement("table","","","table attrTb",""),tbody=document.createElement("tbody"),tbody.appendChild(names),tbody.appendChild(values),tb.appendChild(tbody),$("#pauseDiv").append(tb),$("#pauseDiv").append("附加状态：");for(i in PLAYER_STATUS.buff)void 0!=BUFF_DATA[i].name&&(span=newElement("span",i,"",BUFF_DATA[i].type+"BuffName margin5",BUFF_DATA[i].name),span.onmouseover=function(){$("#pauseDiv div[class='info']").html(BUFF_DATA[this.id].desc)},span.ontouchstart=span.onmouseover,$("#pauseDiv").append(span));$("#pauseDiv").append("<div class='info' style='text-align:left;'>鼠标置于属性名上查看说明</div>"),$("#pauseDiv").append(newElement("button","close","","btn btn-default","返回")),$("#pauseDiv").append("<br>"),"map"==$(".tab-pane.active").attr("id")&&"home"==$("#map").attr("place")&&$("#pauseDiv").append(newElement("button","save","","btn btn-default","保存")),$("#pauseDiv").append(newElement("button","load","","btn btn-default","读取")),$("#pauseDiv").append("<a href='http://tinywaste.lofter.com/post/1dd2c191_9e5eeff' target='_blank' class='btn btn-default'>说明</a>"),$("#close").click(function(){$("#pauseDiv").fadeOut(500,function(){$("#pauseDiv").empty(),$("#overlay").hide(),BATTLE_FLAG||resumeGame()})}),$("#save").click(function(){slView("save")}),$("#load").click(function(){slView("load")})}function slView(mode,flag){var fixCheck,fixInfo,fixDesc,layer=$("#pauseDiv");null!=flag&&($("#beforeGame").html("<div id='buildDiv'></div>"),layer=$("#buildDiv"),layer.hide(),$("#beforeGame").fadeOut(500,function(){$("#beforeGame").fadeIn(500),layer.show()})),layer.empty(),layer.append("<div class='info' style='text-align:left;'>请使用自定义的用户名和密码进行保存和读取，无须注册。</div>"),layer.append(newElement("div","username","","slView","用户名:<input type='text' class='form-control'/>")),layer.append("<br>"),layer.append(newElement("div","pwd","","slView","密码:<input type='password' class='form-control'/>")),layer.append(newElement("button","sl","","btn btn-default","")),null==flag&&(layer.append(newElement("button","back","","btn btn-default","返回")),$("#back").click(function(){layer.empty(),pauseView()})),"save"==mode?($("#sl").html("保存"),$("#sl").click(function(){var name=saveEncode();-1!=name&&(USERNAME=$("#username input").val().replace(/(^s*)|(s*$)/g,""),save(!1,name))})):($("#sl").html("读取"),fixCheck=newElement("input","fixCheck","","",""),fixCheck.type="checkbox",$("#sl").before(fixCheck),fixInfo=newElement("div","fixInfo","","noneBuffName","修复式读取"),$("#sl").before(fixInfo),fixDesc="若你的存档因版本冲突或bug造成数值不正确，可勾选此项。<br>此为自动修复，不保证能识别某些偶然错误，请在修复后仔细检查，确认无误后再保存。",$("#fixInfo").css({cursor:"pointer"}),$("#fixInfo").attr("data-toggle","popover"),$("#fixInfo").attr("data-placement","auto top"),$("#fixInfo").attr("data-container","body"),$("#fixInfo").popover({html:!0,trigger:"click",title:fixDesc}),$("#sl").click(function(){$("#fixInfo").popover("destroy");var name=-1;name=0==$("#username input").val().replace(/(^s*)|(s*$)/g,"").indexOf("loadkey=")?$("#username input").val().replace(/(^s*)|(s*$)/g,"").replace("loadkey=",""):saveEncode(),-1!=name&&($("#sl").html("读取中..."),$("#sl").attr("disabled","disabled"),$.ajax({type:"POST",url:"load.php",data:{key:name},contentType:"application/x-www-form-urlencoded",success:function(msg){var result=JSON.parse(msg.substr(0,msg.indexOf("<script type")));switch(result.msg){case"success":null!=flag?(startGame(),loadData(result.data)?($("#fixCheck").is(":checked")&&fixsave(),$("#beforeGame").fadeOut(1e3,function(){$("#beforeGame").remove(),resumeGame()})):alert("存档文件出现问题，读取失败。")):loadData(result.data)?(resetGame(),loadData(result.data),$("#fixCheck").is(":checked")&&fixsave(),BEGINNER_FLAG||void 0==$("#beginnerFlag").attr("id")||$("#beginnerFlag").remove(),$("#pauseDiv").fadeOut(500,function(){$("#pauseDiv").empty(),$("#overlay").hide(),resumeGame()})):alert("存档文件出现问题，读取失败。"),SAVE_KEY=name;break;default:SAVE_KEY="",alert(result.data)}SAVE_FAST=!1,$("#sl").removeAttr("disabled"),$("#sl").html("读取")},error:function(XMLHttpRequest,textStatus,errorThrown){alert("status:"+XMLHttpRequest.status+"<br>readyState:"+XMLHttpRequest.readyState),SAVE_KEY="",SAVE_FAST=!1,$("#sl").removeAttr("disabled"),$("#sl").html("读取")}}))}))}function saveCheck(){var i,a,username=$("#username input").val().replace(/(^s*)|(s*$)/g,""),pwd=$("#pwd input").val().replace(/(^s*)|(s*$)/g,""),illegal="'\"><*",usnflag=0,pwdflag=0;for(i=0;i<illegal.length;i++)a=illegal.substr(i,i+1),username.indexOf(a)>-1&&(usnflag=1),pwd.indexOf(a)>-1&&(pwdflag=1);return username.length<4||username.length>20?(alert("用户名长度应为4~20。"),0):username.indexOf("　")>-1||username.indexOf(" ")>-1?(alert("用户名不可带空格。"),0):usnflag?(alert("用户名含非法字符。"),0):pwd.length<4||pwd.length>20?(alert("密码长度应为4~20。"),0):pwd.indexOf("　")>-1||pwd.indexOf(" ")>-1?(alert("密码不可带空格。"),0):usnflag?(alert("密码含非法字符。"),0):1}function saveEncode(){var username=$("#username input").val().replace(/(^s*)|(s*$)/g,""),pwd=$("#pwd input").val().replace(/(^s*)|(s*$)/g,"");return saveCheck()?$.md5(username+"k"+pwd,username):-1}function save(overwrite,name){var savefile,savecookie,i;if($("#sl").html("保存中..."),$("#sl").attr("disabled","disabled"),savefile=saveData(),!savefile)return alert("存档生成失败。"),$("#sl").removeAttr("disabled"),$("#sl").html("保存"),$("#fastsave").removeAttr("disabled"),void $("#fastsave").html("快速保存(F6)");savecookie=$.cookie();for(i in savecookie)$.removeCookie(i,{path:"/"});$.ajax({type:"POST",url:"save_test.php",data:{key:name,username:USERNAME,data:savefile,overwrite:overwrite},contentType:"application/x-www-form-urlencoded",success:function(msg){var result=JSON.parse(msg.substr(0,msg.indexOf("<script type")));switch(result.msg){case"repeated":alert("该用户名已存在，请修改用户名再试。");break;case"success":autosave(),alert("保存成功。"),SAVE_FAST||(SAVE_FAST=!0,SAVE_KEY=name,void 0==$("#fastsave").attr("id")&&($("#pauseBtn").before(newElement("button","fastsave","","btn btn-default","快速保存(F6)")),$("#fastsave").click(function(){$("#fastsave").html("保存中..."),$("#fastsave").attr("disabled","disabled"),save(!0,SAVE_KEY)})));break;default:SAVE_KEY="",alert("存档写入出错，请暂时不要关闭游戏，稍后再试。")}$("#sl").removeAttr("disabled"),$("#sl").html("保存"),$("#fastsave").removeAttr("disabled"),$("#fastsave").html("快速保存(F6)")},error:function(XMLHttpRequest,textStatus,errorThrown){alert("status:"+XMLHttpRequest.status+"<br>readyState:"+XMLHttpRequest.readyState),SAVE_KEY="",$("#sl").removeAttr("disabled"),$("#sl").html("保存"),$("#fastsave").removeAttr("disabled"),$("#fastsave").html("快速保存(F6)")}})}function death(){DEATH_FLAG=!0,pauseGame();var deathInfo="你死了<br>死因是："+DEATH_FOR+"<br>总计存活 "+Math.floor((sysTime-originTime)/1e3/60/60/24)+" 天";$("#overlay").fadeTo(10,.01),$("#overlay").fadeTo(1e3,.7),$("#pauseDiv").empty(),$("#pauseDiv").show(),$("#pauseDiv").append("<span style='font-size:1.2em;'>"+deathInfo+"</span><br>"),$("#pauseDiv").append(newElement("button","again","","btn btn-default","重玩")),$("#pauseDiv").append(showAD("messageAD")),$("#load").click(function(){slView("load")}),$("#again").click(function(){DEATH_FLAG=!1,resetGame(),$("#pauseDiv").fadeOut(1e3),$("#background").empty(),$("#overlay").fadeOut(1500,function(){$("#pauseDiv").empty(),BEFORE_GAME.create()})})}function resetGame(){$("body").css({"font-size":"1.3em"}),$("#background").css({"background-color":"#FFFFFF"}),sysTime=new Date("2241/2/1 07:05:00"),EXCRETE_INTERVAL=[20,12],EXCRETE_FLAG=[!1,!1],EXCRETE_MAX=[36,16],WORK_SPEED=1,COOK_SPEED=1,EX_TAB=["origin"],EX_RESOURCE="",TIMER_FLAG=!1,BATTLE_OBJ=new battleObj,BATTLE_ATONCE=!1,BATTLE_FLAG=!1,SAVE_FAST=!1,SAVE_KEY="",BEGINNER_FLAG=!1,BAG_CAP=12,BOX_CAP=10,KETTLE_VOLUME=0,KETTLE_AMOUNT=1,FARM_CAP=1,BAG_DATA={},BOX_DATA={},TEMP_DATA={},TOILET_DATA={},COOK_DATA={},COOK_RESULT={},TOOL_FINISHED=[],TOOL_LEVEL={work:0,tech:0,lab:0,handwork:0,bed:0,cook:0,forge:0,filter:0,train:0},QUEST_FINISHED=[],TRADE_LEVEL=1,TRADE_KINDS=2,TRADE_RATE=15,ITEM_DATA=clone(ITEM_DATA_INIT),TOOL_DATA=clone(TOOL_DATA_INIT),CROP_DATA=clone(CROP_DATA_INIT),MAP_DATA=clone(MAP_DATA_INIT),PLAYER_STATUS=clone(PLAYER_STATUS_INIT),RESEARCH_LIMIT=0,RESEARCH_TIME=clone(originTime),LAST_RAD_TIME=clone(originTime),EXPLORE_FLAG=!1,EXPLORE_TIME=720,EXPLORE_RATE=23,EXPLORE_DATA={},EXPLORE_LASTTIME=clone(originTime),EXPLORE_CHECK=clone(originTime),DISASTER="",DISASTER_EFFECT=!1,DISASTER_CHECK=clone(originTime),DISASTER_TIME=0,DISASTER_LAST=0,DISASTER_LASTTIME=clone(originTime),USERNAME=""}function blink(obj,i){LOAD_FLAG||12>i&&void 0!=obj&&(obj.css({"background-color":i%2==0?"#333333":"#FFFFFF",color:i%2==0?"#FFFFFF":"#000000"}),setTimeout(function(){blink(obj,i+1)},200))}var BEFORE_GAME,GGAD,originTime=new Date("2241/2/1 07:07:00"),sysTime=new Date("2241/2/1 07:05:00"),baseTime=new Date("2241/2/1 00:00:00"),EXCRETE_TIME=[clone(originTime),clone(originTime)],EXCRETE_INTERVAL=[20,12],EXCRETE_FLAG=[!1,!1],EXCRETE_MAX=[36,16],HUNGER_SPEED=1/18,THIRST_SPEED=1/12,WORK_TIME_COST=2.5,WORK_SPEED=1,COOK_SPEED=1,MOVE_SPEED=1,WORK_ENERGY_COST=.1,FPS=20,STATUS_LIST=["life","hunger","thirst","energy","san","radiation"],SPECIAL_LIST=["endurance","perception","charm","luck","agility"],EX_TAB=[],EX_RESOURCE="",TRASH_FLAG=!1,BATTLE_FLAG=!1,RESEARCH_LIMIT=0,RESEARCH_TIME=clone(originTime),LAST_RAD_TIME=clone(originTime),EXPLORE_FLAG=!1,EXPLORE_TIME=720,EXPLORE_RATE=35,EXPLORE_LASTTIME=clone(originTime),EXPLORE_CHECK=clone(originTime),HAIR_AMOUNT=100,DISASTER="",DISASTER_EFFECT=!1,DISASTER_CHECK=clone(originTime),DISASTER_TYPE={sandstorm:{name:"沙尘暴",time:2880,last:1440},rain:{name:"辐射雨",time:4320,last:4320}},DISASTER_TIME=0,DISASTER_LAST=0,DISASTER_LASTTIME=clone(originTime),SAVE_KEY="",SAVE_FAST=!1,SAVE_LIST=["PLAYER_STATUS","BAG_DATA","BOX_DATA","sysTime","EXCRETE_TIME","EXCRETE_FLAG","COOK_DATA","COOK_RESULT","TOILET_DATA","MAP_DATA","TOOL_FINISHED","QUEST_FINISHED","EXPLORE_DATA","DISASTER","DISASTER_TIME","DISASTER_LAST","DISASTER_LASTTIME","BEGINNER_FLAG"],LOAD_FLAG=!1,USERNAME="",DEATH_FLAG=!1,DEATH_FOR="",TIMER_FLAG=!1,BEGINNER_FLAG=!1,TAPHOLD_FLAG=!1;$(document).keyup(function(e){var keycode;document.activeElement.id,document.activeElement.parentNode.id;DEATH_FLAG||"loading"==$(".tab-pane.active").attr("id")||(keycode={49:"(1)",50:"(2)",51:"(3)",52:"(4)",53:"(5)",54:"(6)",65:"(A)",67:"(C)",69:"(E)",68:"(D)",70:"(F)",83:"(S)",87:"(W)"},void 0!=keycode[e.which]&&($(".popover-title .btn").each(function(){return-1!=$(this).html().indexOf(keycode[e.which])&&void 0==$(this).attr("disabled")?void $(this).click():void 0}),BATTLE_FLAG&&(65==e.which&&void 0==$("#attack").attr("disabled")&&$("#attack").click(),68==e.which&&void 0==$("#defence").attr("disabled")&&$("#defence").click(),87==e.which&&void 0==$("#forward").attr("disabled")&&$("#forward").click(),83==e.which&&void 0==$("#backward").attr("disabled")&&$("#backward").click())),117==e.which&&void 0!=$("#fastsave").attr("id")&&(SAVE_FAST=!1,$("#fastsave").html("保存中..."),$("#fastsave").attr("disabled","disabled"),save(!0,SAVE_KEY)))}),BEFORE_GAME=new beforeGameObj,GGAD='<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><!-- tinywaste --><ins class="adsbygoogle"     style="display:block"     data-ad-client="ca-pub-9759799214726921"     data-ad-slot="2055370295"     data-ad-format="auto"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script>';